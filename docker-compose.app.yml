services:
  backend:
    build:
      context: ./
      target: production-backend
    container_name: "${ENV_NAME}-aplikacjakonie-backend"
    image: "ghcr.io/niebieskirekin/aplikacjakonie-backend:${BRANCH}"
    env_file: .env
    networks:
      - traefik
      - postgres
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${ENV_NAME}.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.${ENV_NAME}.entrypoints=https"
      - "traefik.http.routers.${ENV_NAME}.tls=true"
      - "traefik.http.routers.${ENV_NAME}.tls.certResolver=myresolver"
  frontend:
    build:
      context: ./
      target: production-frontend
    container_name: "${ENV_NAME}-aplikacjakonie-frontend"
    image: "ghcr.io/niebieskirekin/aplikacjakonie-frontend:${BRANCH}"
    depends_on:
      backend:
        condition: service_started
        restart: true
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${ENV_NAME}.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${ENV_NAME}.entrypoints=https"
      - "traefik.http.routers.${ENV_NAME}.tls=true"
      - "traefik.http.routers.${ENV_NAME}.tls.certResolver=myresolver"
networks:
  traefik:
    external: true
  postgres:
    external: true
