import { Hono } from "hono";
import { eq } from "drizzle-orm";
import { konie, users, usersInsertSchema, konieInsertSchema } from "../db/schema";
import { db } from "../db";
import { authMiddleware, getUserFromContext, UserPayload } from "../middleware/auth";
import { zValidator } from "@hono/zod-validator";

const horses = new Hono<{ Variables: { user: UserPayload } }>();

horses.use(authMiddleware);

horses.get("/", async (c) => {
  const user = getUserFromContext(c);

  if (!user) {
    return c.json({ error: "B≈ÇƒÖd autoryzacji" }, 401);
  }

  console.log(`üîç Pobieranie koni dla u≈ºytkownika: ${user.email}`);

  const hodowla = await db
    .select()
    .from(users)
    .where(eq(users.id, user.userId))
    .then((res) => res[0]);
  // Pobieramy konie tylko tej samej hodowli
  const horsesList = await db
    .select()
    .from(konie)
    .where(eq(konie.hodowla, hodowla.hodowla));

  console.log("üê¥ Lista koni:", horsesList);

  return c.json(horsesList);
});

// add new ko≈Ñ
horses.post("/", async (c) => {
    try {
      const user = getUserFromContext(c);
      if (!user) return c.json({ error: "B≈ÇƒÖd autoryzacji" }, 401);
  
      const hodowla = await db
        .select({ hodowla: users.hodowla })
        .from(users)
        .where(eq(users.id, user.userId))
        .then((res) => res[0]?.hodowla);
  
      if (!hodowla) {
        return c.json({ error: "Nie znaleziono hodowli u≈ºytkownika" }, 403);
      }
  
      const formData = await c.req.formData();
      const body = {
        nazwa: formData.get("nazwa") as string,
        numerPrzyzyciowy: formData.get("numerPrzyzyciowy") as string,
        numerChipa: formData.get("numerChipa") as string,
        rocznikUrodzenia: parseInt(formData.get("rocznikUrodzenia") as string, 10),
        dataPrzybyciaDoStajni: formData.get("dataPrzybyciaDoStajni")
          ? (formData.get("dataPrzybyciaDoStajni") as string)
          : null,
        dataOdejsciaZeStajni: formData.get("dataOdejsciaZeStajni")
          ? (formData.get("dataOdejsciaZeStajni") as string)
          : null,
        rodzajKonia: formData.get("rodzajKonia") as "Konie hodowlane" | "Konie rekreacyjne" | "≈πrebaki" | "Konie sportowe",
        plec: formData.get("plec") as "samiec" | "samica",
        hodowla: hodowla,
      };
  
      console.log("üê¥ Otrzymane dane konia:", body);
  
      const validationResult = konieInsertSchema.safeParse(body);
      if (!validationResult.success) {
        console.error("B≈ÇƒÖd walidacji:", validationResult.error);
        return c.json({ success: false, error: validationResult.error }, 400);
      }
  
      //Wstawienie danych do bazy
      const newHorse = await db.insert(konie).values(body).returning();
  
      return c.json({ message: "Ko≈Ñ zosta≈Ç dodany!", horse: newHorse });
    } catch (error) {
      console.error("B≈ÇƒÖd podczas dodawania konia:", error);
      return c.json({ error: "B≈ÇƒÖd podczas dodawania konia" }, 500);
    }
  });

export default horses;
